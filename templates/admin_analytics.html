{% extends "base.html" %}

{% block title %}Analytics Dashboard - Admission Management System{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="fas fa-chart-line me-2"></i>
        Analytics Dashboard
    </h2>
    <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
    </a>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card border-primary">
            <div class="card-body text-center">
                <h3 class="text-primary">{{ stats.total }}</h3>
                <p class="mb-0">Total Applications</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card border-success">
            <div class="card-body text-center">
                <h3 class="text-success">{{ stats.acceptance_rate }}%</h3>
                <p class="mb-0">Acceptance Rate</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card border-warning">
            <div class="card-body text-center">
                <h3 class="text-warning">{{ stats.pending }}</h3>
                <p class="mb-0">Pending Review</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card border-info">
            <div class="card-body text-center">
                <h3 class="text-info">{{ stats.today_applications }}</h3>
                <p class="mb-0">Today's Applications</p>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 1 -->
<div class="row mb-4">
    <div class="col-lg-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    Applications by Status
                </h5>
            </div>
            <div class="card-body">
                <canvas id="statusChart"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>
                    Applications by Course
                </h5>
            </div>
            <div class="card-body">
                <canvas id="courseChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 2 -->
<div class="row mb-4">
    <div class="col-lg-12 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    Application Trends (Last 30 Days)
                </h5>
            </div>
            <div class="card-body">
                <canvas id="trendChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Statistics -->
<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-graduation-cap me-2"></i>
                    Top Courses by Applications
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Course</th>
                                <th class="text-end">Total</th>
                                <th class="text-end">Accepted</th>
                                <th class="text-end">Rate</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for course in stats.course_stats %}
                            <tr>
                                <td>{{ course.name }}</td>
                                <td class="text-end">{{ course.total }}</td>
                                <td class="text-end">{{ course.accepted }}</td>
                                <td class="text-end">
                                    <span class="badge bg-{{ 'success' if course.rate >= 50 else 'warning' if course.rate >= 30 else 'secondary' }}">
                                        {{ course.rate }}%
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-calendar-alt me-2"></i>
                    Recent Activity
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th class="text-end">Applications</th>
                                <th class="text-end">Accepted</th>
                                <th class="text-end">Rejected</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for day in stats.daily_stats %}
                            <tr>
                                <td>{{ day.date }}</td>
                                <td class="text-end">{{ day.total }}</td>
                                <td class="text-end">
                                    <span class="badge bg-success">{{ day.accepted }}</span>
                                </td>
                                <td class="text-end">
                                    <span class="badge bg-danger">{{ day.rejected }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
    // Status Chart (Pie)
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    const statusData = [{{ stats.pending or 0 }}, {{ stats.accepted or 0 }}, {{ stats.rejected or 0 }}];
    const hasStatusData = statusData.some(val => val > 0);
    
    if (hasStatusData) {
        new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: ['Pending', 'Accepted', 'Rejected'],
                datasets: [{
                    data: statusData,
                    backgroundColor: ['#ffc107', '#198754', '#dc3545'],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    } else {
        statusCtx.canvas.parentElement.innerHTML = '<p class="text-center text-muted py-5">No data available</p>';
    }
    
    // Course Chart (Bar)
    const courseCtx = document.getElementById('courseChart').getContext('2d');
    const courseLabels = {{ stats.course_labels | tojson }};
    const courseData = {{ stats.course_data | tojson }};
    
    if (courseLabels && courseLabels.length > 0) {
        new Chart(courseCtx, {
            type: 'bar',
            data: {
                labels: courseLabels,
                datasets: [{
                    label: 'Applications',
                    data: courseData,
                    backgroundColor: '#0d6efd',
                    borderColor: '#0d6efd',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    } else {
        courseCtx.canvas.parentElement.innerHTML = '<p class="text-center text-muted py-5">No course data available</p>';
    }
    
    // Trend Chart (Line)
    const trendCtx = document.getElementById('trendChart').getContext('2d');
    const trendLabels = {{ stats.trend_labels | tojson }};
    const trendData = {{ stats.trend_data | tojson }};
    
    if (trendLabels && trendLabels.length > 0) {
        new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: trendLabels,
                datasets: [{
                    label: 'Applications',
                    data: trendData,
                    borderColor: '#17a2b8',
                    backgroundColor: 'rgba(23, 162, 184, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    } else {
        trendCtx.canvas.parentElement.innerHTML = '<p class="text-center text-muted py-5">No trend data available</p>';
    }
</script>
{% endblock %}
