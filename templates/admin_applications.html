{% extends "base.html" %}

{% block title %}Manage Applications - Admission Management System{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="fas fa-users me-2"></i>
        Manage Applications
    </h2>
    <a href="{{ url_for('export_csv') }}" class="btn btn-success">
        <i class="fas fa-download me-2"></i>
        Export CSV
    </a>
</div>

<!-- Search and Filter -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-4">
                <label for="search" class="form-label">Search</label>
                <input type="text" class="form-control" id="search" name="search" 
                       value="{{ search }}" placeholder="Name or Application ID">
            </div>
            <div class="col-md-3">
                <label for="status" class="form-label">Status</label>
                <select class="form-select" id="status" name="status">
                    <option value="">All Status</option>
                    <option value="Pending" {{ 'selected' if status_filter == 'Pending' }}>Pending</option>
                    <option value="Accepted" {{ 'selected' if status_filter == 'Accepted' }}>Accepted</option>
                    <option value="Rejected" {{ 'selected' if status_filter == 'Rejected' }}>Rejected</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="course" class="form-label">Course</label>
                <select class="form-select" id="course" name="course">
                    <option value="">All Courses</option>
                    {% for course in courses %}
                    <option value="{{ course }}" {{ 'selected' if course_filter == course }}>{{ course }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Bulk Actions -->
{% if applications %}
<div class="card mb-3">
    <div class="card-body">
        <form method="POST" action="{{ url_for('bulk_update_status') }}" id="bulkActionForm">
            <div class="row align-items-end">
                <div class="col-md-4">
                    <label class="form-label">Bulk Actions</label>
                    <select class="form-select" name="bulk_status" id="bulkStatus" required>
                        <option value="">Select Action</option>
                        <option value="Accepted">Accept Selected</option>
                        <option value="Rejected">Reject Selected</option>
                        <option value="Pending">Mark as Pending</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Notes (Optional)</label>
                    <input type="text" class="form-control" name="bulk_notes" placeholder="Add notes for all selected applications">
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100" id="bulkApplyBtn" disabled>
                        <i class="fas fa-check me-2"></i>Apply
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endif %}

<!-- Applications Table -->
<div class="card">
    <div class="card-body">
        {% if applications %}
        <div class="table-responsive">
            <table class="table table-striped">
                <thead class="table-dark">
                    <tr>
                        <th style="width: 50px;">
                            <input type="checkbox" class="form-check-input" id="selectAll">
                        </th>
                        <th>Application ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Course</th>
                        <th>Applied Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for app in applications %}
                    <tr>
                        <td>
                            <input type="checkbox" class="form-check-input application-checkbox" name="application_ids" value="{{ app[11] }}" form="bulkActionForm">
                        </td>
                        <td>
                            <code>{{ app[11] }}</code>
                        </td>
                        <td>{{ app[1] }}</td>
                        <td>{{ app[4] }}</td>
                        <td>{{ app[7] }}</td>
                        <td>{{ app[12][:10] }}</td>
                        <td>
                            {% if app[10] == 'Pending' %}
                                <span class="badge bg-warning">{{ app[10] }}</span>
                            {% elif app[10] == 'Accepted' %}
                                <span class="badge bg-success">{{ app[10] }}</span>
                            {% else %}
                                <span class="badge bg-danger">{{ app[10] }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" 
                                    onclick="viewApplication({{ app[0] }}, '{{ app[11] }}', '{{ app[1] }}', '{{ app[2] }}', '{{ app[3] }}', '{{ app[4] }}', '{{ app[5] }}', '{{ app[6] }}', '{{ app[7] }}', '{{ app[8] }}', '{{ app[9] or '' }}', '{{ app[10] }}', '{{ app[13] or '' }}', '{{ app[14] or 'Pending' }}', '{{ app[15] or '' }}')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
            <h5>No applications found</h5>
            <p class="text-muted">Try adjusting your search criteria.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Application Details Modal -->
<div class="modal fade" id="applicationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Application Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="applicationDetails">
                <!-- Application details will be loaded here -->
            </div>
            <div class="modal-footer">
                <form method="POST" action="{{ url_for('update_status') }}" class="d-flex w-100">
                    
                    <input type="hidden" id="modalApplicationId" name="application_id">
                    <select class="form-select me-2" id="modalStatus" name="status" required>
                        <option value="Pending">Pending</option>
                        <option value="Accepted">Accepted</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                    <input type="text" class="form-control me-2" name="admin_notes" 
                           placeholder="Admin notes (optional)">
                    <button type="submit" class="btn btn-primary">Update</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
